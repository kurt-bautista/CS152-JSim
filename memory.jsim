.include "ALU.jsim"

.subckt controlunit OPCODE[5:0] Z PCSEL[1:0] RA2SEL BSEL WDSEL[1:0] ALUFN[5:0] Wr WERF 

    Xconn_1 OPCODE[5:0] OPCODEZ[6:1] knex
    .connect OPCODEZ0 Z

    * Control Unit
    Xmem
    + vdd 0 0 OPCODEZ[6:0] PCSEL[1:0] RA2SEL BSEL WDSEL[1:0] ALUFN[5:0] Wr WERF 
    + $memory width=14 nlocations=128
    + contents=(
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00011000000001 // LD
        + 0b00011000000001 // LD
        + 0b00110000000010 // ST
        + 0b00110000000010 // ST
        + 0b00000000000000
        + 0b00000000000000
        + 0b10000000000001 // JMP
        + 0b10000000000001 // JMP
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000001 // BEQ
        + 0b01000000000001 // BEQ
        + 0b01000000000001 // BNE
        + 0b00000000000001 // BNE
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000100000001 // ADD
        + 0b00000100000001 // ADD
        + 0b00000100000101 // SUB
        + 0b00000100000101 // SUB
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000111001101 // CMPEQ
        + 0b00000111001101 // CMPEQ
        + 0b00000111010101 // CMPLT
        + 0b00000111010101 // CMPLT
        + 0b00000111011101 // CMPLE
        + 0b00000111011101 // CMPLE
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000101100001 // AND
        + 0b00000101100001 // AND
        + 0b00000101111001 // OR
        + 0b00000101111001 // OR
        + 0b00000111011001 // XOR
        + 0b00000111011001 // XOR
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000110000001 // SHL
        + 0b00000110000001 // SHL
        + 0b00000110000101 // SHR
        + 0b00000110000101 // SHR
        + 0b00000110001101 // SRA
        + 0b00000110001101 // SRA
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00000000000000
        + 0b00010111001101 // CMPEQC
        + 0b00010111001101 // CMPEQC
        + 0b00010111010101 // CMPLTC
        + 0b00010111010101 // CMPLTC
        + 0b00010111011101 // CMPLEC
        + 0b00010111011101 // CMPLEC
        + 0b00000000000000
        + 0b00000000000000
        + 0b00010101100001 // ANDC
        + 0b00010101100001 // ANDC
        + 0b00010101111001 // ORC
        + 0b00010101111001 // ORC
        + 0b00010111011001 // XORC
        + 0b00010111011001 // XORC
        + 0b00000000000000
        + 0b00000000000000
        + 0b00010110000001 // SHLC
        + 0b00010110000001 // SHLC
        + 0b00010110000101 // SHRC
        + 0b00010110000101 // SHRC
        + 0b00010110001101 // SRAC
        + 0b00010110001101 // SRAC
        + 0b00000000000000
        + 0b00000000000000
    + )

.ends

.subckt datamemory clock A[9:0] WD[31:0] Wr RD[31:0] reset

    Xmux reset Wr 0 wres mux2

    Xmem
    + vdd 0 0 A[9:0] RD[31:0]
    + 0 clock wres A[9:0] WD[31:0]
    + $memory width=32 nlocations=1024
    + file="test.bsim.bin"
.ends

.subckt instructionmemory A[9:0] D[31:0]
    Xmem
    + vdd 0 0 A[9:0] D[31:0]
    + $memory width=32 nlocations=1024
    + file="test.bsim.bin"
.ends

.subckt registers clock WD[31:0] WE WA[4:0] RA1a[4:0] RA2a[4:0] RD1d[31:0] RD2d[31:0] reset

    Xmux reset WE 0 WEres mux2

    *Disable write if R31
    Xand_1 WA4 WA3 WA2 WA1 a and4
    Xnand_1 a WA0 b nand2
    Xand_2 b WEres wre and2

    Xmem
    + 0 clock wre WA[4:0] WD[31:0]
    + vdd 0 0 RA1a[4:0] RD1d[31:0]
    + vdd 0 0 RA2a[4:0] RD2d[31:0]
    + $memory width=32 nlocations=32
    + contents=(
        + 0 0 0 0 0 0 0 0
        + 0 0 0 0 0 0 0 0
        + 0 0 0 0 0 0 0 0
        + 0 0 0 0 0 0 0 0)

.ends

* Wop OPCODE[5:0] nrz(0, 5, 100ns, 0ns, 0.1ns, 0.1ns) 0
* Wz z nrz(0, 5, 100ns, 0ns, 0.1ns, 0.1ns) 0
* Xcu_test OPCODE[5:0] z a[1:0] b c d[1:0] e[5:0] f g controlunit

* .tran 100ns
* .plot a[1:0]
* .plot d[1:0]
* .plot e[5:0]
* .plot g

* Counter
* Ws reset nrz(0, 5, 15ns, 0ns, 0.1ns, 0.1ns) 1 0
* Xreset reset#32 sum[31:0] 0#32 muxOut[31:0] mux2
* Xregisters muxOut[31:0] clk2#32 b[31:0] dreg